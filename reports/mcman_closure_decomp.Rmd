---
title: "Closure Decomposition"
author: "Mark Hagemann"
date: "April 11, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In a previous document I decomposed the variability of flow resistance (Manning's n) in time and space using Pepsi 1 cases. In this docoument I will explore that idea further, expanding it to include components of flow imbalance. These two quantities--flow imbalance and Manning n variability--constitute the closure term for Mass-conserved Manning's equation as used to infer $A_0$. 

## Model

Mass-conserved Manning (McMan) assumes the following relationship holds:

$$
A_{it} X_{it} = A_{it} (W_{it}^{-2/3} S_{it}^{1/2})^{3/5} =  nQ_t
$$

Departures from this relationship can arise from the following conditions:

- Flow resistance, $n$, varies in time and/or space. Spatial variability can come from change in bed material between reaches; time variability can come from interdependence between stream depth and flow resistance. 
- Spatial variability in $Q_t$ arising from non-steady-state flow conditions.
- Lateral influx/outflux of water resulting in non-mass-conserved conditions.
- Invalidity of Manning's equation assumptions. 

Note that these do not account for other sources of error such as measurement or parameter uncertainty. 

In order to account for these departures, instead write the true equality as

$$
A_{it} X_{it} =  n_{it}Q_{it} = (\nu_{it} \gamma_{it})\bar{n}\bar{Q}_t 
$$

where $\gamma_{it} = Q_{it} / \bar{Q}$ represents flow variability and $\nu_{it} = n_{it} / \bar{n}$ represents all other sources of multiplicative error. $\bar{n}$ and $\bar{Q}_t$ can be computed variously from $n_{it}$ and $Q_{it}$, but the most natural choice is the geometric mean, ensuring that $\nu$ and $\gamma$ both have geometric mean of 1. 

Since $\gamma_{it}$ is comprised prinicpally from flow imbalance due to non-steady-state conditions, the time series it contains will be highly correlated in space. Furthermore, the reach containing the mean location along the river section will have $\gamma_t$ close to zero, and the magnitude of $\gamma_t$ will increase further upstream and downstream from this middle reach. Reaches downstream of the middle reach will have $\gamma$ time series that are positively correlated with one another and negatively correlated those upstream of the middle reach. The time-series structure of $\gamma$ is likely to be negligible at SWOT overpass time scales, but significant at approximately daily time scales. An example of this structure can be seen in the following subset of the Po River data. 

```{r}
reachdata$Po %>% 
  # swot_sset(keeptimes = 100:120) %>% 
  swot_gamma() %>% 
  plot_DAWG() +
  scale_y_log10() +
  xlim(100, 120) +
  # ylim(0.8, 1.2) +
  ylab("gamma") +
  theme_bw()
```

Since $\gamma$ is a multiplicative term, it can be modeled in log space as

$$
\ln \gamma_{it} = \tau_i \ln [\bar{\gamma_{\cdot t}}] + \epsilon_{it}
$$


```{r}
casei <- reachdata$Po

gami <- casei %>% 
  swot_gamma() %>% 
  log()

plot_DAWG(gami)

disti <- casei$x - mean(casei$x)
  

gami_adj <- gami / disti

gamdot <- apply(gami_adj, 2, mean) # "characteristic" departure from Qbar
plot(gamdot, type = "l")

plot_DAWG(gami_adj - swot_vec2mat(gamdot, gami_adj)) # Still not great in terms of error structure

# Shouldn't error structure of *that* be location-dependent?

gamdep2 <- gami_adj - swot_vec2mat(gamdot, gami_adj)

plot(as.vector(gamdep2) %>% abs(), as.vector(disti) %>% abs())

```

